<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema Taller (Memoria Activa)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { background-color: #f3f4f6; font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* GAVETAS */
        .gavetas-container {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            scrollbar-width: none; 
        }
        .gavetas-container::-webkit-scrollbar { display: none; }
        
        .tab-btn {
            white-space: nowrap;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 2px 5px rgba(37, 99, 235, 0.3);
        }

        /* COLORES DE ESTADO */
        .card-taller { border-left: 5px solid #9ca3af; background: white; }
        .card-proceso { border-left: 5px solid #3b82f6; background: #eff6ff; }
        .card-server { border-left: 5px solid #9333ea; background: #f3e8ff; }
        .card-listo { border-left: 5px solid #eab308; background: #fefce8; }
        .card-nosepudo { border-left: 5px solid #374151; background: #e5e7eb; opacity: 0.7; }
        .card-entregado { border-left: 5px solid #22c55e; background: #dcfce7; }

        /* ANIMACIONES */
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }

        /* IMPRESI√ìN */
        @media print {
            body * { visibility: hidden; }
            #modalRecibo, #modalRecibo * { visibility: visible; }
            #modalRecibo { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; display: flex; align-items: flex-start; justify-content: center; padding-top: 20px; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800">

    <header class="bg-white pt-4 px-4 pb-2 shadow-sm sticky top-0 z-30">
        <div class="flex justify-between items-end border-b border-gray-100 pb-2 mb-2">
            <div>
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">CAJA (HOY)</p>
                <h2 class="text-2xl font-black text-gray-800 tracking-tight" id="displayCaja">RD$ 0</h2>
            </div>
            <div class="text-right">
                 <button onclick="borrarDatos()" class="text-[10px] text-gray-300 underline mb-1">Resetear App</button>
                <h2 class="text-lg font-bold text-blue-600" id="contadorOrdenes">0 Trabajos</h2>
            </div>
        </div>
        
        <div class="relative mb-1">
            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-sm"></i>
            <input type="text" id="buscador" onkeyup="filtrarTexto()" placeholder="Buscar..." 
                   class="w-full pl-9 pr-3 py-2 bg-gray-100 rounded-lg text-sm focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition border-none">
        </div>
    </header>

    <nav class="gavetas-container sticky top-[125px] z-20" id="navGavetas">
        <button onclick="filtrarGaveta('todos')" class="tab-btn active" id="tab-todos">Todo</button>
        <button onclick="filtrarGaveta('taller')" class="tab-btn" id="tab-taller">‚ö™ Taller</button>
        <button onclick="filtrarGaveta('proceso')" class="tab-btn" id="tab-proceso">üîµ Proceso</button>
        <button onclick="filtrarGaveta('server')" class="tab-btn" id="tab-server">üü£ Server</button>
        <button onclick="filtrarGaveta('listo')" class="tab-btn" id="tab-listo">üü° Listos</button>
        <button onclick="filtrarGaveta('nosepudo')" class="tab-btn" id="tab-nosepudo">‚ùå Fallidos</button>
        <button onclick="filtrarGaveta('entregado')" class="tab-btn" id="tab-entregado">‚úÖ Entregados</button>
    </nav>

    <main id="listaOrdenes" class="flex-1 overflow-y-auto p-3 space-y-3 pb-24 bg-gray-50">
        </main>

    <button onclick="abrirModal()" class="fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition z-40 active:bg-blue-800">
        <i class="fas fa-plus"></i>
    </button>

    <div id="modalRegistro" class="hidden fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl overflow-hidden animate-slide-up h-[80vh] sm:h-auto flex flex-col shadow-2xl">
            <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-gray-700">Nueva Orden</h3>
                <button onclick="cerrarModal()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-5 space-y-4 overflow-y-auto flex-1">
                <div>
                    <label class="text-xs font-bold text-gray-400 ml-1">CLIENTE</label>
                    <input type="text" id="inCliente" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500 font-semibold">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-400 ml-1">EQUIPO</label>
                        <input type="text" id="inEquipo" placeholder="Ej: A13" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 ml-1">PRECIO</label>
                        <input type="number" id="inPrecio" placeholder="RD$" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-green-500 font-bold text-green-700">
                    </div>
                </div>
                
                <div>
                    <label class="text-xs font-bold text-gray-400 ml-1">FALLO / SERVICIO</label>
                    <input type="text" id="inFallo" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500">
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-400 ml-1">IMEI (OPCIONAL)</label>
                    <input type="text" id="inImei" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-blue-500 text-sm font-mono">
                </div>
                
                <div>
                    <label class="text-xs font-bold text-gray-400 ml-1">GAVETA INICIAL</label>
                    <select id="inEstado" class="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none mt-1">
                        <option value="taller">‚ö™ En Taller</option>
                        <option value="proceso">üîµ En Proceso</option>
                        <option value="server">üü£ V√≠a Server</option>
                        <option value="listo">üü° Listo</option>
                        <option value="entregado">‚úÖ Entregado</option>
                    </select>
                </div>
            </div>
            
            <div class="p-4 border-t bg-white">
                <button onclick="guardar()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-700 transform active:scale-95 transition">Guardar Orden</button>
            </div>
        </div>
    </div>

    <div id="modalAcciones" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 animate-slide-up">
            <h3 class="text-center font-bold text-lg mb-4 text-gray-800">Mover a Gaveta:</h3>
            <div class="grid grid-cols-2 gap-3" id="botonesCambioEstado">
                </div>
            <button onclick="cerrarAcciones()" class="w-full mt-4 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200">Cancelar</button>
        </div>
    </div>

    <div id="modalRecibo" class="hidden fixed inset-0 bg-white z-[60] flex items-center justify-center p-4">
        <div class="w-[300px] font-mono text-sm p-6 border border-gray-200 shadow-2xl bg-white rounded-sm">
            <div class="text-center mb-4">
                <h2 class="font-bold text-xl tracking-tighter">CENTRO T√âCNICO</h2>
                <p class="text-xs uppercase">Desbloqueos & Reparaciones</p>
                <p class="text-xs mt-1" id="tFecha">--/--/--</p>
            </div>
            <div class="border-b border-dashed border-gray-400 my-3"></div>
            <div class="flex justify-between font-bold text-base">
                <span>ORDEN</span>
                <span id="tId">#000</span>
            </div>
            <div class="mt-2 text-xs text-gray-500 uppercase">Cliente</div>
            <div class="font-bold text-lg mb-1" id="tCliente">---</div>
            <div class="border-b border-dashed border-gray-400 my-3"></div>
            <div class="flex justify-between mb-4 items-start">
                <span id="tDetalle" class="w-2/3 leading-tight">---</span>
                <span id="tPrecio" class="font-bold">0</span>
            </div>
            <div class="border-b border-dashed border-gray-400 my-3"></div>
            <div class="flex justify-between text-xl font-black mt-2">
                <span>TOTAL</span>
                <span id="tTotal">RD$ 0</span>
            </div>
            <div class="text-center mt-8 text-[10px] text-gray-400">
                <p>Gracias por su preferencia</p>
            </div>
            <div class="mt-6 flex gap-2 no-print">
                <button onclick="window.print()" class="flex-1 bg-gray-900 text-white py-3 rounded-lg font-bold"><i class="fas fa-print"></i> Imprimir</button>
                <button onclick="cerrarRecibo()" class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-lg font-bold">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // --- L√ìGICA DE MEMORIA ---
        const DB_KEY = 'taller_app_data_v1';
        
        let ordenes = [];
        let nextId = 1000;
        let filtroActual = 'todos';
        let idSeleccionado = null;

        // 1. Cargar datos al iniciar
        function cargarDatos() {
            const guardado = localStorage.getItem(DB_KEY);
            if(guardado) {
                const data = JSON.parse(guardado);
                ordenes = data.ordenes;
                nextId = data.nextId;
            } else {
                // Datos de prueba si est√° vac√≠o
                ordenes = [
                    { id: 1000, cliente: "Prueba Inicial", equipo: "Sistema", fallo: "Bienvenida", precio: 0, estado: "taller", fecha: new Date().toLocaleDateString() }
                ];
            }
        }

        // 2. Guardar datos (se llama tras cada cambio)
        function guardarEnMemoria() {
            const data = {
                ordenes: ordenes,
                nextId: nextId
            };
            localStorage.setItem(DB_KEY, JSON.stringify(data));
        }

        function borrarDatos() {
            if(confirm("¬øEST√ÅS SEGURO? Se borrar√°n todos los trabajos y la caja volver√° a cero.")) {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        // --- RENDERIZADO ---
        function renderizar() {
            const contenedor = document.getElementById('listaOrdenes');
            contenedor.innerHTML = '';
            
            // Caja del d√≠a (Filtramos solo los entregados HOY para la caja del d√≠a, o total hist√≥rico seg√∫n prefieras)
            // Por simplicidad, sumaremos todos los "Entregados" que est√°n en la lista.
            const totalCaja = ordenes.filter(o => o.estado === 'entregado').reduce((sum, o) => sum + o.precio, 0);
            document.getElementById('displayCaja').innerText = `RD$ ${totalCaja.toLocaleString()}`;
            document.getElementById('contadorOrdenes').innerText = `${ordenes.length} Registros`;

            // Filtros
            let lista = ordenes;
            if(filtroActual !== 'todos') {
                lista = ordenes.filter(o => o.estado === filtroActual);
            }
            
            const texto = document.getElementById('buscador').value.toLowerCase();
            if(texto) {
                lista = lista.filter(o => 
                    o.cliente.toLowerCase().includes(texto) || 
                    o.equipo.toLowerCase().includes(texto) || 
                    (o.imei && o.imei.includes(texto))
                );
            }

            // Dibujar Cards
            lista.forEach(ord => {
                let badge = '', botones = '';
                
                switch(ord.estado) {
                    case 'taller':
                        badge = '<span class="bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded font-bold">EN TALLER</span>';
                        botones = `<button onclick="menuAcciones(${ord.id})" class="text-blue-600 font-bold text-xs bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100">Gestionar</button>`;
                        break;
                    case 'proceso':
                        badge = '<span class="bg-blue-100 text-blue-600 text-[10px] px-2 py-0.5 rounded font-bold">EN PROCESO</span>';
                        botones = `<button onclick="menuAcciones(${ord.id})" class="text-blue-600 font-bold text-xs bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100">Actualizar</button>`;
                        break;
                    case 'server':
                        badge = '<span class="bg-purple-100 text-purple-600 text-[10px] px-2 py-0.5 rounded font-bold">SERVER ‚òÅÔ∏è</span>';
                        botones = `<button onclick="menuAcciones(${ord.id})" class="text-purple-600 font-bold text-xs bg-purple-50 px-3 py-1.5 rounded-lg border border-purple-100">Estado?</button>`;
                        break;
                    case 'listo':
                        badge = '<span class="bg-yellow-100 text-yellow-700 text-[10px] px-2 py-0.5 rounded font-bold">‚ö†Ô∏è LISTO</span>';
                        botones = `<button onclick="entregar(${ord.id})" class="bg-green-500 text-white font-bold text-xs px-4 py-2 rounded-lg shadow-md hover:bg-green-600 animate-pulse">ENTREGAR</button>`;
                        break;
                    case 'nosepudo':
                        badge = '<span class="bg-gray-600 text-gray-200 text-[10px] px-2 py-0.5 rounded font-bold">FALLIDO</span>';
                        botones = `<button onclick="entregar(${ord.id})" class="text-gray-500 font-bold text-xs border border-gray-300 px-3 py-1.5 rounded-lg">Devolver</button>`;
                        break;
                    case 'entregado':
                        badge = '<span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded font-bold">‚úÖ ENTREGADO</span>';
                        botones = `
                            <div class="flex gap-2">
                                <button onclick="verTicket(${ord.id})" class="w-8 h-8 flex items-center justify-center bg-white border border-gray-200 rounded-full text-gray-600 hover:text-black shadow-sm"><i class="fas fa-print"></i></button>
                                <button onclick="eliminarOrden(${ord.id})" class="w-8 h-8 flex items-center justify-center bg-white border border-red-100 rounded-full text-red-300 hover:text-red-600"><i class="fas fa-trash"></i></button>
                            </div>`;
                        break;
                }

                const html = `
                    <div class="p-4 rounded-xl shadow-sm mb-3 relative card-${ord.estado}">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="text-[10px] text-gray-400 font-black tracking-wide">ORDEN #${ord.id}</span>
                                <h4 class="font-bold text-gray-800 text-lg">${ord.cliente}</h4>
                                <div class="text-sm text-gray-600 mt-0.5 flex items-center gap-2">
                                    <span class="font-medium">${ord.equipo}</span>
                                    <span class="text-gray-300">|</span>
                                    <span>${ord.fallo}</span>
                                </div>
                                ${ord.imei ? `<div class="text-[10px] font-mono text-gray-400 mt-1 bg-gray-50 inline-block px-1 rounded">IMEI: ${ord.imei}</div>` : ''}
                            </div>
                            <div class="text-right flex flex-col items-end gap-1">
                                <span class="font-black text-lg text-gray-800">RD$ ${ord.precio.toLocaleString()}</span>
                                ${badge}
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-100">
                            <span class="text-[10px] font-bold text-gray-400 uppercase"><i class="far fa-calendar"></i> ${ord.fecha}</span>
                            <div class="flex gap-2">
                                ${botones}
                            </div>
                        </div>
                    </div>
                `;
                contenedor.innerHTML += html;
            });
        }

        // --- ACCIONES ---
        function guardar() {
            const cliente = document.getElementById('inCliente').value;
            const equipo = document.getElementById('inEquipo').value;
            const precio = document.getElementById('inPrecio').value;
            
            if(!cliente || !equipo) return alert("Falta Cliente o Equipo");

            ordenes.unshift({
                id: nextId++,
                cliente, equipo,
                precio: parseFloat(precio) || 0,
                fallo: document.getElementById('inFallo').value,
                imei: document.getElementById('inImei').value,
                estado: document.getElementById('inEstado').value,
                fecha: new Date().toLocaleDateString()
            });

            guardarEnMemoria(); // <--- GUARDAR
            cerrarModal();
            limpiarForm();
            renderizar();
        }

        function menuAcciones(id) {
            idSeleccionado = id;
            const modal = document.getElementById('modalAcciones');
            const grid = document.getElementById('botonesCambioEstado');
            
            grid.innerHTML = `
                <button onclick="cambiarEstado('taller')" class="p-4 rounded-xl bg-gray-50 border border-gray-200 font-bold text-gray-600 hover:bg-gray-100 text-sm">‚ö™ Taller</button>
                <button onclick="cambiarEstado('proceso')" class="p-4 rounded-xl bg-blue-50 border border-blue-100 font-bold text-blue-600 hover:bg-blue-100 text-sm">üîµ Proceso</button>
                <button onclick="cambiarEstado('server')" class="p-4 rounded-xl bg-purple-50 border border-purple-100 font-bold text-purple-600 hover:bg-purple-100 text-sm">üü£ Server</button>
                <button onclick="cambiarEstado('listo')" class="p-4 rounded-xl bg-yellow-50 border border-yellow-100 font-bold text-yellow-700 hover:bg-yellow-100 text-sm">üü° Listo</button>
                <button onclick="cambiarEstado('nosepudo')" class="p-4 rounded-xl bg-gray-700 border border-gray-600 font-bold text-white hover:bg-gray-800 text-sm col-span-2">‚ùå No se pudo</button>
            `;
            modal.classList.remove('hidden');
        }

        function cambiarEstado(nuevoEstado) {
            const item = ordenes.find(o => o.id === idSeleccionado);
            if(item) {
                item.estado = nuevoEstado;
                guardarEnMemoria(); // <--- GUARDAR
                renderizar();
            }
            cerrarAcciones();
        }

        function entregar(id) {
            const item = ordenes.find(o => o.id === id);
            if(confirm(`¬øConfirmar entrega y cobrar RD$ ${item.precio}?`)) {
                item.estado = 'entregado';
                guardarEnMemoria(); // <--- GUARDAR
                renderizar();
            }
        }
        
        function eliminarOrden(id) {
            if(confirm("¬øEliminar registro permanentemente?")) {
                ordenes = ordenes.filter(o => o.id !== id);
                guardarEnMemoria(); // <--- GUARDAR
                renderizar();
            }
        }

        // --- UI ---
        function filtrarGaveta(estado) {
            filtroActual = estado;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${estado}`).classList.add('active');
            renderizar();
        }
        function filtrarTexto() { renderizar(); }
        function abrirModal() { document.getElementById('modalRegistro').classList.remove('hidden'); }
        function cerrarModal() { document.getElementById('modalRegistro').classList.add('hidden'); }
        function cerrarAcciones() { document.getElementById('modalAcciones').classList.add('hidden'); }
        function limpiarForm() {
            document.querySelectorAll('#modalRegistro input').forEach(i => i.value = '');
            document.getElementById('inEstado').value = 'taller';
        }

        function verTicket(id) {
            const o = ordenes.find(i => i.id === id);
            document.getElementById('tId').innerText = `#${o.id}`;
            document.getElementById('tFecha').innerText = o.fecha;
            document.getElementById('tCliente').innerText = o.cliente;
            document.getElementById('tDetalle').innerText = `${o.equipo} - ${o.fallo}`;
            document.getElementById('tPrecio').innerText = `RD$ ${o.precio.toLocaleString()}`;
            document.getElementById('tTotal').innerText = `RD$ ${o.precio.toLocaleString()}`;
            document.getElementById('modalRecibo').classList.remove('hidden');
        }
        function cerrarRecibo() { document.getElementById('modalRecibo').classList.add('hidden'); }

        // --- INICIO APP ---
        cargarDatos(); // Cargar al abrir
        renderizar();
    </script>
</body>
</html>